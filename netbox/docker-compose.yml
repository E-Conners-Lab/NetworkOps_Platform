version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: netbox-postgres
    environment:
      POSTGRES_DB: netbox
      POSTGRES_USER: netbox
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-netbox}
    volumes:
      - netbox-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U netbox"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: netbox-redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis-cache:
    image: redis:7-alpine
    container_name: netbox-redis-cache
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  netbox:
    image: netboxcommunity/netbox:v4.1
    container_name: netbox
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      redis-cache:
        condition: service_healthy
    environment:
      CORS_ORIGIN_ALLOW_ALL: "true"
      DB_HOST: postgres
      DB_NAME: netbox
      DB_USER: netbox
      DB_PASSWORD: ${POSTGRES_PASSWORD:-netbox}
      REDIS_HOST: redis
      REDIS_CACHE_HOST: redis-cache
      SECRET_KEY: ${NETBOX_SECRET_KEY}
      SUPERUSER_NAME: ${NETBOX_SUPERUSER:-admin}
      SUPERUSER_EMAIL: ${NETBOX_SUPERUSER_EMAIL:-admin@example.com}
      SUPERUSER_PASSWORD: ${NETBOX_SUPERUSER_PASSWORD:-admin}
      SUPERUSER_API_TOKEN: ${NETBOX_API_TOKEN}
      SKIP_SUPERUSER: "false"
      ALLOWED_HOSTS: "*"
      CSRF_TRUSTED_ORIGINS: "http://localhost:8000 http://127.0.0.1:8000"
    ports:
      - "8000:8080"
    volumes:
      - netbox-media:/opt/netbox/netbox/media
      - netbox-reports:/opt/netbox/netbox/reports
      - netbox-scripts:/opt/netbox/netbox/scripts
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s
    restart: unless-stopped

  netbox-worker:
    image: netboxcommunity/netbox:v4.1
    container_name: netbox-worker
    depends_on:
      netbox:
        condition: service_healthy
    environment:
      DB_HOST: postgres
      DB_NAME: netbox
      DB_USER: netbox
      DB_PASSWORD: ${POSTGRES_PASSWORD:-netbox}
      REDIS_HOST: redis
      REDIS_CACHE_HOST: redis-cache
      SECRET_KEY: ${NETBOX_SECRET_KEY}
    command: /opt/netbox/venv/bin/python /opt/netbox/netbox/manage.py rqworker
    volumes:
      - netbox-media:/opt/netbox/netbox/media
      - netbox-reports:/opt/netbox/netbox/reports
      - netbox-scripts:/opt/netbox/netbox/scripts
    restart: unless-stopped

  netbox-housekeeping:
    image: netboxcommunity/netbox:v4.1
    container_name: netbox-housekeeping
    depends_on:
      netbox:
        condition: service_healthy
    environment:
      DB_HOST: postgres
      DB_NAME: netbox
      DB_USER: netbox
      DB_PASSWORD: ${POSTGRES_PASSWORD:-netbox}
      REDIS_HOST: redis
      REDIS_CACHE_HOST: redis-cache
      SECRET_KEY: ${NETBOX_SECRET_KEY}
    command: /opt/netbox/housekeeping.sh
    volumes:
      - netbox-media:/opt/netbox/netbox/media
      - netbox-reports:/opt/netbox/netbox/reports
      - netbox-scripts:/opt/netbox/netbox/scripts
    restart: unless-stopped

volumes:
  netbox-postgres-data:
  netbox-media:
  netbox-reports:
  netbox-scripts:
